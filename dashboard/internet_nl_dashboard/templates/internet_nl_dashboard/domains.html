{% extends 'internet_nl_dashboard/templates/internet_nl_dashboard/_base.html' %}{% load humanize %}{% load i18n %}
<!-- Todo: the input has to be a select2 type... when you paste a set of urls, it get parsed into
    multiple separate urls. -->
    <!-- Vue bootstrap for this table? -->
    <!-- https://bootstrap-vue.js.org/docs/components/table -->
    <!-- do we need undo options? -->
    <!-- https://github.com/ArthurClemens/Javascript-Undo-Manager -->

{% block content %}
<script type="text/x-template" id="modal-template">
  <transition name="modal">
    <div class="modal-mask">
      <div class="modal-wrapper">
        <div class="modal-container">

          <div class="modal-header">
            <button style="float:right;" type="button" class="close" data-dismiss="modal" aria-label="Close" @click="$emit('close')">
                <span aria-hidden="true">&times;</span>
            </button>
            <slot name="header">
              default header

            </slot>

          </div>

          <div class="modal-body">
            <slot name="body">
              default body
            </slot>
          </div>

          <div class="modal-footer">
            <slot name="footer">
              default footer
              <button class="modal-default-button" @click="$emit('close')">
                OK
              </button>
            </slot>
          </div>
        </div>
      </div>
    </div>
  </transition>
</script>

<div id="list_manager"></div>
{% verbatim %}
<!-- Todo: find nice edit component to inline edit. -->
<script type="x-template" id="lists">
    <div>
        <modal v-if="show_new" @close="stop_adding_new()">
            <h3 slot="header">Add new list</h3>

            <div slot="body">

                <div v-if="add_new_response.error">
                    <!-- todo: translation -->
                    <h2>❌ Not saved</h2>
                    {{ add_new_response.message }}
                </div>
                <div v-if="add_new_response.success">
                    <!-- todo: translation -->
                    <h2>✅ Saved!</h2>
                    {{ add_new_response.message }}
                </div>

                <label for="name">List name:</label>
                <input id="name" type="text" maxlength="120" v-model="new_list.name"><br><br>

                <label for="enable_scans">Enable scans:</label>
                <input id="enable_scans" type="checkbox" v-model="new_list.enable_scans"><br><br>

                <label for="scan_type">What scan to run:</label>
                <select id="scan_type" v-model="new_list.scan_type">
                        <option value="web">Web</option>
                        <option value="mail">Mail</option>
                </select><br><br>

                <label for="automated_scan_frequency">How often should the scan run?:</label>
                <select id="automated_scan_frequency" v-model="new_list.automated_scan_frequency">
                    <option value="disabled">Disabled</option>
                    <option value="every half year">Every half year</option>
                    <option value="at the start of every quarter">At the start of every quarter</option>
                    <option value="every 1st day of the month">Every 1st day of the month</option>
                    <option value="twice per month">Twice per month</option>
                </select>

            </div>
            <div slot="footer">
                <button class="modal-default-button" @click="stop_adding_new()">Close</button>
                <button @click="create_list()">Create List</button>
            </div>
        </modal>


        <h1>Domains</h1>
        <p>This address manager will be 'really' built later on, especially given the risk the UI is not usable for
        everyone, and because of further developing requirements. The list below is extremely rudimentary and will not
        resemble the final product. It has been built to experiment how file uploads are processed, and to show
        something has happened after processing.</p>
        <p>Upload large amount of data: <a href="/upload/">{% endverbatim %}{% trans "Bulk Address Uploader" %}{% verbatim %}</a></p>

        <button @click="start_adding_new()">New</button>

        <h2>Lists</h2>
        <managed-url-list v-for="list in lists" :initial_list="list"></managed-url-list>

    </div>
</script>

<script type="x-template" id="managed-url-list">
    <div>
        <modal v-if="show_list_settings" @close="stop_editing_settings()">
            <h3 slot="header">🖊 Edit list settings</h3>
            <div slot="body">
                <div v-if="settings_update_response.error">
                    <!-- todo: translation -->
                    <h2>❌ Not saved</h2>
                    {{ settings_update_response.message }}
                </div>
                <div v-if="settings_update_response.success">
                    <!-- todo: translation -->
                    <h2>✅ Saved!</h2>
                    {{ settings_update_response.message }}
                </div>

                <label for="name">List name:</label>
                <input id="name" type="text" maxlength="120" v-model="list.name"><br><br>

                <label for="enable_scans">Enable scans:</label>
                <input id="enable_scans" type="checkbox" v-model="list.enable_scans"><br><br>

                <label for="scan_type">What scan to run:</label>
                <select id="scan_type" v-model="list.scan_type">
                        <option value="web">Web</option>
                        <option value="mail">Mail</option>
                </select><br><br>

                <label for="automated_scan_frequency">How often should the scan run?:</label>
                <select id="automated_scan_frequency" v-model="list.automated_scan_frequency">
                    <option value="disabled">Disabled</option>
                    <option value="every half year">Every half year</option>
                    <option value="at the start of every quarter">At the start of every quarter</option>
                    <option value="every 1st day of the month">Every 1st day of the month</option>
                    <option value="twice per month">Twice per month</option>
                </select>

            </div>
            <div slot="footer">
                <button @click="stop_editing_settings()">Close</button>
                <button class="modal-default-button" @click="update_list_settings()">Update</button>
            </div>
        </modal>

        <h3>
            <button v-if="!has_urls()" @click="get_urls(list.id)" value="load">Open</button>
            <button v-if="has_urls()" @click="close_list()" value="load">Close</button>
            <span @click="get_urls(list.id)">
                <span title="Web scans will be performed" v-if="list.enable_scans && list.scan_type === 'mail'">📨</span>
                <span title="Web scans will be performed" v-if="list.enable_scans && list.scan_type === 'web'">🌐</span>
                <span title="No scans will be performed" v-if="!list.enable_scans">🚫</span>

                {{ list.name }}</span>
        </h3>

        <div v-if="has_urls()">
            <h4>Settings <button @click="start_editing_settings()">🖊️ Edit</button></h4>
            Scanning enabled: {{ list.enable_scans }} <br>
            Type of scan performed: {{ list.scan_type }} <br>
            Scan frequency: {{ list.automated_scan_frequency }} <br>
            Next scheduled scan: {{ humanize_date(list.scheduled_next_scan) }} <br>


            <h4>Actions:</h4>
            <button @click="get_urls(list.id)" value="load">Duplicate</button>
            <button @click="get_urls(list.id)" value="load">Delete</button>

            <div>
                <label for="add_urls[]">Bulk add new:</label>
                <select class="js-example-basic-multiple" name="add_urls[]" multiple="multiple" style="width: 100%"></select>
            </div>

            <div style="column-count: 2;">
                <div v-for="url in urls">
                    <span title="Edit this domain" @click="url_edit = 'edit_' + list.id + url.url">🖊</span>

                    <span v-if="url.has_mail_endpoint" title="Is eligeble for e-mail scans">
                        <a :href="'https://www.internet.nl/mail/' + url.url + '/'" target="_blank">📨</a>
                    </span>
                    <span v-if="!url.has_mail_endpoint" title="Is not eligeble for e-mail scans">🚫</span>
                    <span v-if="url.has_web_endpoint" title="Is eligeble for web scans">
                        <a :href="'https://www.internet.nl/site/' + url.url + '/'" target="_blank">🌐</a>
                    </span>
                    <span v-if="!url.has_web_endpoint" title="Is not eligeble for web scans">🚫</span>


                    <a :id="'edit_' + list.id + url.url" @click="url_edit = 'edit_' + list.id + url.url">{{ url.url }}</a>
                    <!-- (<a :href="'https://' + url.url" target="_blank" rel="noreferrer">open</a>) -->

                    <template v-if="url_edit === 'edit_' + list.id + url.url">
                        <div>
                            <input :placeholder="url.url" :value="url.url" style="width: 100%">
                            <!-- This is not a real 'save' but an add to list and create if it doesn't exist operation. -->
                            <button>Cancel</button><button>Save</button>
                            <button style="float: right;">Delete</button>
                        </div>
                    </template>

                    <!-- <button type="button">Edit</button><button type="button">Remove</button> -->
                </div>
            </div>
        </div>
    </div>
</script>
{% endverbatim %}

<script>
Vue.component('modal', {
  template: '#modal-template'
});


// todo: add new, remove, drag to other list(?)
vueListManager = new Vue({
    name: 'list_manager',
    el: '#list_manager',
    template: '#lists',
    mixins: [],
    data: {
        loading: false,
        lists: [],

        // everything that has something to do with adding a new list:
        show_new: false,
        add_new_loading: false,
        add_new_response: {},
        new_list: {}
    },
    mounted: function () {
        this.load();
    },
    methods: {
        load: function() {
            this.get_lists();
        },
        get_lists: function(){
            this.loading = true;
            fetch(`/data/urllists/get/`).then(response => response.json()).then(data => {
                this.lists = data;
                this.loading = false;
            }).catch((fail) => {console.log('A loading error occurred: ' + fail);});
        },
        start_adding_new: function(){
            this.new_list = {'id': -1, 'name': '', 'enable_scans': false, 'scan_type': 'web',
                'automated_scan_frequency': 'disabled', 'scheduled_next_scan': '1'};
            this.show_new = true;

        },
        stop_adding_new: function() {
            this.show_new = false;
        },
        create_list: function() {
            this.add_new_loading = true;
            (async () => {
              const rawResponse = await fetch('/data/urllist/create_list/', {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json',
                  'X-CSRFToken': get_cookie('csrftoken')
                },
                body: JSON.stringify(this.new_list)
              });
              try {
                  this.add_new_response = await rawResponse.json();
              } catch (e) {
                  // SyntaxError: JSON.parse: unexpected character at line 1 column 1 of the JSON data
                  this.add_new_response = {'error': true, 'message': 'Server error'}
              }

              console.log(this.add_new_response);

              if (this.add_new_response.data.account){
                // the data section contains what we've added
                console.log('pushing');
                this.lists.push(this.add_new_response.data);
                // should we order the list alphabetically / or re-apply the orderering there is now?
                // how do we scroll to the new list?
                // is it possible to have a an animation on everything that is added to the list?
              }

              this.add_new_loading = false;
            })();
        }
    }
});

Vue.component('managed-url-list', {
    mixins: [humanize_mixin],

    data: function () {
        return {
            urls: [],
            loading: false,
            url_edit: '',

            // contains all known list data, should not be needed to individually fetch the list (again), only
            // after update.
            list: this.initial_list,

            // everything to do with settings.
            show_list_settings: false,
            settings_loading: false,
            settings_update_response: {},
            old_list_settings: {},
        }
    },
    props: {
        initial_list: Object,
    },
    methods: {
        get_urls: function(){
            this.loading = true;
            fetch(`/data/urllist_content/get/${this.list.id}/`).then(response => response.json()).then(data => {
                this.urls = data.urls;
                this.loading = false;
                // there is no way to get a 'after render' in vue?
                setTimeout(enable_select, 10);
            }).catch((fail) => {console.log('A loading error occurred: ' + fail);});
        },
        close_list: function(){
            this.urls = [];
        },
        update_list_settings: function(){
            this.settings_loading = true;
            (async () => {
              const rawResponse = await fetch('/data/urllist/update_list_settings/', {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json',
                  'X-CSRFToken': get_cookie('csrftoken')
                },
                body: JSON.stringify(this.list)
              });
              try {
                  this.settings_update_response = await rawResponse.json();
              } catch (e) {
                  // SyntaxError: JSON.parse: unexpected character at line 1 column 1 of the JSON data
                  this.settings_update_response = {'error': true, 'message': 'Server error'}
              }
              console.log(this.settings_update_response);
              this.settings_loading = false;
            })();
        },
        start_editing_settings: function(){
            // keep an old value in memory. If the editing is canceled, the old value should be used.
            // here a weakness is of js is showing:
            // https://stackoverflow.com/questions/728360/how-do-i-correctly-clone-a-javascript-object
            // luckily we can use the simple approach...
            this.old_list_settings = JSON.parse(JSON.stringify(this.list));
            this.show_list_settings = true;
        },
        stop_editing_settings: function(){
            // reset the state
            this.show_list_settings = false;

            // no is empty javascript native.
            if (jQuery.isEmptyObject(this.settings_update_response) || this.settings_update_response.error) {
                console.log('No changes saved or no save attempt. Reverting.');
                this.list = JSON.parse(JSON.stringify(this.old_list_settings));
            }
            this.settings_update_response = {};
        },
        has_urls: function(){
          return this.urls.length > 0;
        }
    },
    template: '#managed-url-list'
});


function enable_select(){
    $('.js-example-basic-multiple').select2({
        placeholder: 'example.com, www.example.com, www.internet.nl, ...',
        tags: true,
        tokenSeparators: [',', ' '],
        // hides the no results box, as this is pure tagbox only
        // @see: https://stackoverflow.com/questions/18470917/disable-no-matches-found-text-and-autocomplete-on-select2
        "language":{
            "noResults" : function () { return ''; }
        },

        // after 26 characters searching became insanely slow. So don't match for now.
        // this is not an issue caused by the matcher but by something else...
        // matcher: function() {return null},

        createTag: function (params) {
            // This is an extremely naive implementation of domain validation. On the server tldextract is
            // used which is much more complete as it uses the public suffixes list.
            // This is just a convenience check that something with a dot is entered.
            let term = $.trim(params.term);

            // ... this might work for punycode but not for unicode.
            // we want to support unicode...
            // http://www.w3.org/TR/html5/links.html#attr-hyperlink-href:
            var pattern = new RegExp('^((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,})$'); // domain name
            if (!pattern.test(term)) {
                return null;
            }

            if (term === '') {
                return null;
            }

            return {
                id: term,
                text: term,
            }
        }
    });
}

</script>
{% endblock %}
