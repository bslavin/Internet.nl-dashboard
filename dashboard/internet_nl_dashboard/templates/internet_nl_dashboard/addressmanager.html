{% extends 'internet_nl_dashboard/base.html' %}{% load humanize %}{% load i18n %}
<!-- Todo: the input has to be a select2 type... when you paste a set of urls, it get parsed into
    multiple separate urls. -->
    <!-- Vue bootstrap for this table? -->
    <!-- https://bootstrap-vue.js.org/docs/components/table -->
    <!-- do we need undo options? -->
    <!-- https://github.com/ArthurClemens/Javascript-Undo-Manager -->

{% block content %}
<script type="text/x-template" id="modal-template">
  <transition name="modal">
    <div class="modal-mask">
      <div class="modal-wrapper">
        <div class="modal-container">

          <div class="modal-header">
            <slot name="header">
              default header
            </slot>
          </div>

          <div class="modal-body">
            <slot name="body">
              default body
            </slot>
          </div>

          <div class="modal-footer">
            <slot name="footer">
              default footer
              <button class="modal-default-button" @click="$emit('close')">
                OK
              </button>
            </slot>
          </div>
        </div>
      </div>
    </div>
  </transition>
</script>

<div id="list_manager"></div>
{% verbatim %}
<!-- Todo: find nice edit component to inline edit. -->
<script type="x-template" id="lists">
    <div>
        <h1>Domains</h1>
        <p>This address manager will be 'really' built later on, especially given the risk the UI is not usable for
        everyone, and because of further developing requirements. The list below is extremely rudimentary and will not
        resemble the final product. It has been built to experiment how file uploads are processed, and to show
        something has happened after processing.</p>
        <p>Upload large amount of data: <a href="/upload/">{% endverbatim %}{% trans "Bulk Address Uploader" %}{% verbatim %}</a></p>

        <modal v-if="show_new" @close="show_new = false">
            <h3 slot="header">Add new list</h3>
            <div slot="body">
                <label for="new_list_name">List name:</label><input id="new_list_name" type="text" name="list_name" v-model="new_list_name">
            <label for="new_list_type">What scan to run:</label>
                <select id="new_list_type" v-model="new_list_scan_type">
                        <option value="web">Web</option>
                        <option value="mail">Mail</option>
                </select>
            </div>
            <div slot="footer">
                <button class="modal-default-button" @click="$emit('close')">Close</button>
                <button @click="create_list()">Create List</button>
            </div>
        </modal>
        <button @click="show_new = true">New</button>

        <h2>Lists</h2>
        <managed-url-list v-for="list in lists" :initial_list="list"></managed-url-list>

    </div>
</script>

<script type="x-template" id="managed-url-list">
    <div>
        <h3 @dblclick="rename_list(list.id)">
            <button v-if="!has_urls()" @click="get_urls(list.id)" value="load">Open</button>
            <button v-if="has_urls()" @click="close_list()" value="load">Close</button>
            <span @click="get_urls(list.id)">{{ list.name }}</span> 🖊️
        </h3>

        <div v-if="has_urls()">
            This list will scan: {{ list.scan_type }}

            <button @click="get_urls(list.id)" value="load">Duplicate</button>
            <button @click="get_urls(list.id)" value="load">Delete</button>

            <div>
                <label for="add_urls[]">Bulk add new:</label>
                <select class="js-example-basic-multiple" name="add_urls[]" multiple="multiple" style="width: 100%"></select>
            </div>

            <div style="column-count: 2;">
                <div v-for="url in urls">
                    <span title="Edit this domain" @click="url_edit = 'edit_' + list.id + url.url">🖊</span>

                    <span v-if="url.has_mail_endpoint" title="Is eligeble for e-mail scans">
                        <a :href="'https://www.internet.nl/mail/' + url.url + '/'" target="_blank">📨</a>
                    </span>
                    <span v-if="!url.has_mail_endpoint" title="Is not eligeble for e-mail scans">🚫</span>
                    <span v-if="url.has_web_endpoint" title="Is eligeble for web scans">
                        <a :href="'https://www.internet.nl/site/' + url.url + '/'" target="_blank">🌐</a>
                    </span>
                    <span v-if="!url.has_web_endpoint" title="Is not eligeble for web scans">🚫</span>


                    <a :id="'edit_' + list.id + url.url" @click="url_edit = 'edit_' + list.id + url.url">{{ url.url }}</a>
                    <!-- (<a :href="'https://' + url.url" target="_blank" rel="noreferrer">open</a>) -->

                    <template v-if="url_edit === 'edit_' + list.id + url.url">
                        <div>
                            <input :placeholder="url.url" :value="url.url" style="width: 100%">
                            <!-- This is not a real 'save' but an add to list and create if it doesn't exist operation. -->
                            <button>Save</button>
                            <button style="float: right;">Delete</button>
                        </div>
                    </template>

                    <!-- <button type="button">Edit</button><button type="button">Remove</button> -->
                </div>
            </div>
        </div>
    </div>
</script>
{% endverbatim %}

<script>
Vue.component('modal', {
  template: '#modal-template'
});


// todo: add new, remove, drag to other list(?)
vueListManager = new Vue({
    name: 'list_manager',
    el: '#list_manager',
    template: '#lists',
    mixins: [],
    data: {
        loading: false,
        lists: [],

        show_new: false,
        new_list_name: '',
        new_list_scan_type: '',
        /*
        * {1: {}, 2: [], 3: []}
        * */
        list_content: {},
    },
    mounted: function () {
        this.load();
    },
    methods: {
        load: function() {
            this.get_lists();
        },
        get_lists: function(){
            this.loading = true;
            fetch(`/data/urllists/get/`).then(response => response.json()).then(data => {
                this.lists = data;
                this.loading = false;
            }).catch((fail) => {console.log('A loading error occurred: ' + fail);});
        },
    }
});

Vue.component('managed-url-list', {
    data: function () {
        return {
            urls: [],
            loading: false,
            url_edit: '',
            list: this.initial_list,
        }
    },
    props: {
        initial_list: Object,
    },
    methods: {
        get_urls: function(){
            this.loading = true;
            fetch(`/data/urllist_content/get/${this.list.id}/`).then(response => response.json()).then(data => {
                this.urls = data.urls;
                this.loading = false;
                // there is no way to get a 'after render' in vue?
                setTimeout(enable_select, 10);
            }).catch((fail) => {console.log('A loading error occurred: ' + fail);});
        },
        close_list: function(){
            this.urls = [];
        },
        rename_list: function(list_id){

        },
        has_urls: function(){
          return this.urls.length > 0;
        }
    },
    template: '#managed-url-list'
});


function enable_select(){
    $('.js-example-basic-multiple').select2({
        placeholder: 'example.com, www.example.com, www.internet.nl, 1...',
        tags: true,
        tokenSeparators: [',', ' '],
        createTag: function (params) {
            // This is an extremely naive implementation of domain validation. On the server tldextract is
            // used which is much more complete as it uses the public suffixes list.
            // This is just a convenience check that something with a dot is entered.
            let term = $.trim(params.term);

            // ... this might work for punycode but not for unicode.
            // we want to support unicode...
            // http://www.w3.org/TR/html5/links.html#attr-hyperlink-href:
            var pattern = new RegExp('^((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,})$'); // domain name
            if (!pattern.test(term)) {
                return null;
            }

            if (term === '') {
                return null;
            }

            return {
                id: term,
                text: term,
            }
        }
    });
}

</script>
{% endblock %}
